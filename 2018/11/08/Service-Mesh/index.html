<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="服务网格（Service Mesh），由轻量级的网络代理实现服务间通讯和服务治理相关功能，是云原生微服务的运行时平台。 主要的好处：  减轻服务重量，服务治理功能独立到服务网格中，可单独升级 跨语言，服务网格和应用开发语言无关，有利于小众编程语言 流量控制，安全认证，监控指标等功能齐全  可以降低开发门槛，让开发人员专注业务逻辑；并提高运维对应用/服务的统一控制和监控。 Istio目前是服务网格中">
<meta property="og:type" content="article">
<meta property="og:title" content="服务网格">
<meta property="og:url" content="https://wewld.com/2018/11/08/Service-Mesh/index.html">
<meta property="og:site_name" content="We Wld">
<meta property="og:description" content="服务网格（Service Mesh），由轻量级的网络代理实现服务间通讯和服务治理相关功能，是云原生微服务的运行时平台。 主要的好处：  减轻服务重量，服务治理功能独立到服务网格中，可单独升级 跨语言，服务网格和应用开发语言无关，有利于小众编程语言 流量控制，安全认证，监控指标等功能齐全  可以降低开发门槛，让开发人员专注业务逻辑；并提高运维对应用/服务的统一控制和监控。 Istio目前是服务网格中">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://wewld.com/images/pasted-3.png">
<meta property="og:image" content="https://wewld.com/images/流量管理.png">
<meta property="og:image" content="https://wewld.com/images/pilot架构.png">
<meta property="og:image" content="https://wewld.com/images/服务版本.png">
<meta property="og:image" content="https://wewld.com/images/pasted-4.png">
<meta property="og:image" content="https://wewld.com/images/金丝雀部署.png">
<meta property="og:image" content="https://wewld.com/images/服务发现和负载均衡.png">
<meta property="og:image" content="https://wewld.com/images/mixer.png">
<meta property="og:updated_time" content="2019-03-31T23:17:15.052Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="服务网格">
<meta name="twitter:description" content="服务网格（Service Mesh），由轻量级的网络代理实现服务间通讯和服务治理相关功能，是云原生微服务的运行时平台。 主要的好处：  减轻服务重量，服务治理功能独立到服务网格中，可单独升级 跨语言，服务网格和应用开发语言无关，有利于小众编程语言 流量控制，安全认证，监控指标等功能齐全  可以降低开发门槛，让开发人员专注业务逻辑；并提高运维对应用/服务的统一控制和监控。 Istio目前是服务网格中">
<meta name="twitter:image" content="https://wewld.com/images/pasted-3.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"hide","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://wewld.com/2018/11/08/Service-Mesh/"/>





  <title>服务网格 | We Wld</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">We Wld</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">public static void main</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://wewld.com/2018/11/08/Service-Mesh/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="masen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="We Wld">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">服务网格</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-08T07:36:00+08:00">
                2018-11-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>服务网格（Service Mesh），由轻量级的网络代理实现服务间通讯和服务治理相关功能，是云原生微服务的运行时平台。</p>
<p>主要的好处：</p>
<ul>
<li>减轻服务重量，服务治理功能独立到服务网格中，可单独升级</li>
<li>跨语言，服务网格和应用开发语言无关，有利于小众编程语言</li>
<li>流量控制，安全认证，监控指标等功能齐全</li>
</ul>
<p>可以降低开发门槛，让开发人员专注业务逻辑；并提高运维对应用/服务的统一控制和监控。</p>
<p>Istio目前是服务网格中最广泛采用的一个实现方案，本篇主要是对Istio的资料整理，以及输出一个SpringBoot2程序在Istio环境下的实践Example。</p>
<h2 id="Istio"><a href="#Istio" class="headerlink" title="Istio"></a>Istio</h2><p>Google，IBM，Lyft 联合开源的服务网格，提供连接、保护、控制和观测服务的功能。</p>
<p>Istio 的主要特性包括：</p>
<ul>
<li>流量管理：服务治理功能更加强大</li>
<li>安全：服务通信的认证、授权和加密</li>
<li>可观察性：策略控制和遥测收集，提供后端抽象和中介</li>
<li>平台支持：Kubernetes，Consul</li>
<li>集成和定制:策略执行组件可以扩展和定制，以便与现有的 ACL、日志、监控、配额、审计等方案集成</li>
</ul>
<h3 id="架构模式："><a href="#架构模式：" class="headerlink" title="架构模式："></a>架构模式：</h3><p>Istio 服务网格逻辑上分为数据平面和控制平面。</p>
<ul>
<li>数据平面由一组以 sidecar 方式部署的智能代理（Envoy）组成。这些代理可以调节和控制微服务及 Mixer 之间所有的网络通信。</li>
<li>控制平面负责管理和配置代理来路由流量。此外控制平面配置 Mixer 以实施策略和收集遥测数据。</li>
</ul>
<p><img src="\images\pasted-3.png" alt=""></p>
<ul>
<li>Envoy：sidecar / proxy，Istio 使用 Envoy 代理的扩展版本，调解服务网格中所有服务的入站和出站流量。它支持动态服务发现、负载均衡、TLS 、HTTP/2 和 gPRC 代理、熔断、健康检查、故障注入和性能测量等丰富的功能。</li>
<li>Mixer：访问控制、执行策略并从 Envoy 代理中收集遥测数据。Mixer 支持灵活的插件模型，方便扩展（支持 GCP、AWS、Prometheus、Heapster 等多种后端）。</li>
<li>Pilot：动态管理 Envoy 实例的生命周期，提供服务发现、智能路由（例如 A/B 测试、金丝雀部署等）和弹性流量管理（如超时、重试、熔断器等）等功能。它将流量管理策略转化为 Envoy 数据平面配置，并传播到 sidecar 中。Pilot 将服务发现机制抽象为符合 Envoy 数据平面 API 的标准格式，以便支持在多种环境下运行并保持流量管理的相同操作接口。</li>
<li>Citadel 通过内置身份和凭证管理提供服务间和最终用户的身份认证。支持基于角色的访问控制、基于服务标识的策略执行等。</li>
</ul>
<h3 id="设计目标"><a href="#设计目标" class="headerlink" title="设计目标"></a>设计目标</h3><ul>
<li>最大化透明度：自动Sidecar注入与流量劫持</li>
<li>增量：扩展策略系统，集成其他策略和控制来源</li>
<li>可移植性：最少的代价运行在任何云或预置环境中</li>
<li>策略一致性：策略系统作为独特的服务来维护</li>
</ul>
<h3 id="流量管理"><a href="#流量管理" class="headerlink" title="流量管理"></a>流量管理</h3><h4 id="Pilot-和-Envoy"><a href="#Pilot-和-Envoy" class="headerlink" title="Pilot 和 Envoy"></a>Pilot 和 Envoy</h4><p>Istio 流量管理的核心组件是 Pilot，它管理和配置部署在特定 Istio 服务网格中的所有 Envoy 代理实例。它允许您指定在 Envoy 代理之间使用什么样的路由流量规则，并配置故障恢复功能，如超时、重试和熔断器。它还维护了网格中所有服务的规范模型，并使用这个模型通过发现服务让 Envoy 了解网格中的其他实例。</p>
<p>每个 Envoy 实例都会维护负载均衡信息，负载均衡信息是基于从 Pilot 获得的信息，以及其负载均衡池中的其他实例的定期健康检查。从而允许其在目标实例之间智能分配流量，同时遵循其指定的路由规则。</p>
<h4 id="流量管理的好处"><a href="#流量管理的好处" class="headerlink" title="流量管理的好处"></a>流量管理的好处</h4><p>使用 Istio 的流量管理模型，本质上是将流量与基础设施扩容解耦，通过 Pilot 指定特定服务的 5％ 流量可以转到金丝雀版本，或根据请求的内容将流量发送到特定版本。</p>
<p><img src="/images/流量管理.png" alt=""><br>将流量从基础设施扩展中解耦，这样就可以让 Istio 提供各种流量管理功能，这些功能在应用程序代码之外。<br>除了 A/B 测试的动态请求路由，逐步推出和金丝雀发布之外，它还使用超时、重试和熔断器处理故障恢复，最后还可以通过故障注入来测试服务之间故障恢复策略的兼容性。</p>
<p><img src="/images/pilot架构.png" alt="upload successful"><br>Pilot 维护了网格中的服务的规范表示，这个表示是独立于底层平台的并做特定适配。然后公开了用于服务发现 、负载均衡池和路由表的动态更新的 API。这些 API 将 Envoy 从平台特有的细微差别中解脱出来，简化了设计并提升了跨平台的可移植性。</p>
<h4 id="服务之间的通讯"><a href="#服务之间的通讯" class="headerlink" title="服务之间的通讯"></a>服务之间的通讯</h4><p>Istio 的流量路由规则可以根据服务版本来对服务之间流量进行附加控制。这些版本不一定是不同的 API 版本：它们可能是部署在不同环境（prod、staging 或者 dev 等）中的同一服务的不同迭代。</p>
<p><img src="/images/服务版本.png" alt="upload successful"></p>
<p>使用 Pilot 指定路由规则，Envoy 根据这些规则动态地确定其服务版本的实际选择。</p>
<p>服务的客户端不知道服务不同版本间的差异。Envoy sidecar/代理拦截并转发客户端和服务器之间的所有请求和响应。</p>
<p>路由规则让 Envoy 能够根据诸如 header、与源/目的地相关联的标签和/或分配给每个版本的权重等标准来进行版本选择。</p>
<h4 id="网关与路由"><a href="#网关与路由" class="headerlink" title="网关与路由"></a>网关与路由</h4><p><img src="\images\pasted-4.png" alt=""></p>
<ol>
<li><p><strong>istio-ingressgateway</strong>:  入口 IP 和端口配置 ， 使用外部负载均衡或NodePort，将外部流量导入到gateway</p>
</li>
<li><p><strong>Gateway</strong>:  对标kubernetes ingress, 用于为 HTTP / TCP 流量配置负载均衡器，并不管该负载均衡器将在哪里运行， 只用于配置L4-L6功能（例如，对外公开的端口，TLS 配置），通过标签查找对应的L7 VirtualService 路由配置</p>
</li>
<li><p><strong>VirtualService</strong>: L7层路由规则，描述可寻址目标到网格内实际工作负载之间的映射。还可以配置超时，重试</p>
</li>
<li><p><strong>DestinationRule</strong>: 请求被 VirtualService 路由之后，DestinationRule 配置的一系列策略就生效了，由服务提供者撰写，用于描述断路器，负载均衡设置，TLS 设置等。 </p>
</li>
<li><p><strong>ServiceEntry</strong>: 对访问网格外部依赖的流量进行建模，例如访问 Web 上的 API 或遗留基础设施中的服务。</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">#Gateway 配置</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: Gateway</span><br><span class="line">metadata:</span><br><span class="line">  name: bookinfo-gateway</span><br><span class="line">spec:</span><br><span class="line">  servers:</span><br><span class="line">  - port:</span><br><span class="line">      number: 443</span><br><span class="line">      name: https</span><br><span class="line">      protocol: HTTPS</span><br><span class="line">    hosts:</span><br><span class="line">    - bookinfo.com</span><br><span class="line">    tls:</span><br><span class="line">      mode: SIMPLE</span><br><span class="line">      serverCertificate: /tmp/tls.crt</span><br><span class="line">      privateKey: /tmp/tls.key</span><br><span class="line">      </span><br><span class="line">#VirtualService 配置</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: VirtualService</span><br><span class="line">metadata:</span><br><span class="line">  name: bookinfo</span><br><span class="line">spec:</span><br><span class="line">  hosts:</span><br><span class="line">    - bookinfo.com</span><br><span class="line">  http:</span><br><span class="line">  - match:</span><br><span class="line">    - uri:</span><br><span class="line">        prefix: /reviews</span><br><span class="line">    route:</span><br><span class="line">    - destination:</span><br><span class="line">        host: reviews</span><br><span class="line">  - match:</span><br><span class="line">    - uri:</span><br><span class="line">        prefix: /ratings</span><br><span class="line">    route:</span><br><span class="line">    - destination:</span><br><span class="line">        host: ratings</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">#DestinationRule 配置</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: DestinationRule</span><br><span class="line">metadata:</span><br><span class="line">  name: reviews</span><br><span class="line">spec:</span><br><span class="line">  host: reviews</span><br><span class="line">  trafficPolicy:</span><br><span class="line">    loadBalancer:</span><br><span class="line">      simple: RANDOM</span><br><span class="line">  subsets:</span><br><span class="line">  - name: v1</span><br><span class="line">    labels:</span><br><span class="line">      version: v1</span><br><span class="line">  - name: v2</span><br><span class="line">    labels:</span><br><span class="line">      version: v2</span><br><span class="line">    trafficPolicy:</span><br><span class="line">      loadBalancer:</span><br><span class="line">        simple: ROUND_ROBIN</span><br><span class="line">  - name: v3</span><br><span class="line">    labels:</span><br><span class="line">      version: v3</span><br></pre></td></tr></table></figure>
<h5 id="在服务之间分拆流量"><a href="#在服务之间分拆流量" class="headerlink" title="在服务之间分拆流量"></a>在服务之间分拆流量</h5><p>VirtualService不仅定义路由规则，还可以分拆流量<br>例如下面会把 25% 的 reviews 服务流量分配给 v2 标签；其余的 75% 流量分配给 v1：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: VirtualService</span><br><span class="line">metadata:</span><br><span class="line">  name: reviews</span><br><span class="line">spec:</span><br><span class="line">  hosts:</span><br><span class="line">    - reviews</span><br><span class="line">  http:</span><br><span class="line">  - route:</span><br><span class="line">    - destination:</span><br><span class="line">        host: reviews</span><br><span class="line">        subset: v1</span><br><span class="line">      weight: 75</span><br><span class="line">    - destination:</span><br><span class="line">        host: reviews</span><br><span class="line">        subset: v2</span><br><span class="line">      weight: 25</span><br></pre></td></tr></table></figure>
<h5 id="金丝雀部署"><a href="#金丝雀部署" class="headerlink" title="金丝雀部署"></a>金丝雀部署</h5><p>利用负载均衡配置实现金丝雀部署<br><img src="\images\金丝雀部署.png" alt="upload successful"><br>执行bookinfo.yaml ： 此时，三个版本的 reviews 服务以负载均衡的方式轮询。</p>
<p>#创建默认路由，全部请求转发到 v1<br>$ istioctl create -f samples/bookinfo/routing/route-rule-all-v1.yaml<br>istioctl get virtualservices -o yaml</p>
<h4 id="服务发现和负载均衡"><a href="#服务发现和负载均衡" class="headerlink" title="服务发现和负载均衡"></a>服务发现和负载均衡</h4><p>服务注册：Istio 对接诸如 Kubernetes、Mesos 等平台已经为基于容器的应用程序提供了这样的功能。</p>
<p>服务发现：Pilot 使用来自服务注册的信息，并提供与平台无关的服务发现接口。网格中的 Envoy 实例执行服务发现，并相应地动态更新其负载均衡池。<br><img src="/images/服务发现和负载均衡.png" alt="upload successful"><br>网格中的服务使用其 DNS 名称访问彼此。服务的所有 HTTP 流量都会通过 Envoy 自动重新路由。Envoy 在负载均衡池中的实例之间分发流量。</p>
<h5 id="目标规则-负载均衡策略"><a href="#目标规则-负载均衡策略" class="headerlink" title="目标规则-负载均衡策略"></a>目标规则-负载均衡策略</h5><p>在请求被 VirtualService 路由之后，DestinationRule 配置的一系列策略就生效了。<br>下面是 reviews 服务的 DestinationRule 配置策略以及子集：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: DestinationRule</span><br><span class="line">metadata:</span><br><span class="line">  name: reviews</span><br><span class="line">spec:</span><br><span class="line">  host: reviews</span><br><span class="line">  trafficPolicy:</span><br><span class="line">    loadBalancer:</span><br><span class="line">      simple: RANDOM</span><br><span class="line">  subsets:</span><br><span class="line">  - name: v1</span><br><span class="line">    labels:</span><br><span class="line">      version: v1</span><br><span class="line">  - name: v2</span><br><span class="line">    labels:</span><br><span class="line">      version: v2</span><br><span class="line">    trafficPolicy:</span><br><span class="line">      loadBalancer:</span><br><span class="line">        simple: ROUND_ROBIN</span><br><span class="line">  - name: v3</span><br><span class="line">    labels:</span><br><span class="line">      version: v3</span><br></pre></td></tr></table></figure>
<p>注意在单个 DestinationRule 配置中可以包含多条策略（比如 default 和 v2）。</p>
<h4 id="故障处理"><a href="#故障处理" class="headerlink" title="故障处理"></a>故障处理</h4><p>Envoy 提供了一套开箱即用，可选的的故障恢复功能，对应用中的服务大有裨益。这些功能包括：</p>
<ol>
<li>超时</li>
<li>具备超时预算，并能够在重试之间进行可变抖动（间隔）的有限重试功能</li>
<li>并发连接数和上游服务请求数限制</li>
<li>对负载均衡池中的每个成员进行主动（定期）运行健康检查</li>
<li>细粒度熔断器（被动健康检查）- 适用于负载均衡池中的每个实例</li>
</ol>
<h5 id="请求超时"><a href="#请求超时" class="headerlink" title="请求超时"></a>请求超时</h5><p>缺省情况下，HTTP 请求的超时设置为 15 秒，可以使用路由规则来覆盖这个限制：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kind: VirtualService</span><br><span class="line">spec:</span><br><span class="line">  http:</span><br><span class="line">  - route:</span><br><span class="line">    timeout: 1s</span><br></pre></td></tr></table></figure></p>
<h5 id="重试"><a href="#重试" class="headerlink" title="重试"></a>重试</h5><p>设置最大重试次数，或者在规定时间内一直重试，时间长度同样可以进行覆盖：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kind: VirtualService</span><br><span class="line">spec:</span><br><span class="line">  http:</span><br><span class="line">  - route:</span><br><span class="line">    retries:</span><br><span class="line">      attempts: 3</span><br><span class="line">      perTryTimeout: 2s</span><br></pre></td></tr></table></figure></p>
<h5 id="目标规则-熔断"><a href="#目标规则-熔断" class="headerlink" title="目标规则-熔断"></a>目标规则-熔断</h5><ul>
<li><p>并发连接数和上游服务请求数限制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">kind: DestinationRule</span><br><span class="line">  subsets:</span><br><span class="line">  - name: v1</span><br><span class="line">    trafficPolicy:</span><br><span class="line">      connectionPool:</span><br><span class="line">        tcp:</span><br><span class="line">          maxConnections: 1</span><br><span class="line">        http:</span><br><span class="line">          http1MaxPendingRequests: 1</span><br><span class="line">          maxRequestsPerConnection: 1</span><br></pre></td></tr></table></figure>
</li>
<li><p>调用下游服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kind: DestinationRule</span><br><span class="line">spec:</span><br><span class="line">  trafficPolicy:</span><br><span class="line">    outlierDetection:</span><br><span class="line">      consecutiveErrors: 1</span><br><span class="line">      interval: 1s</span><br><span class="line">      baseEjectionTime: 3m</span><br><span class="line">      maxEjectionPercent: 100</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="微调"><a href="#微调" class="headerlink" title="微调"></a>微调</h5><p>Istio 的流量管理规则允许运维人员为每个服务/版本设置故障恢复的全局默认值。然而，服务的消费者也可以通过特殊的 HTTP 头提供的请求级别值覆盖超时和重试的默认值。在 Envoy 代理的实现中，对应的 Header 分别是 x-envoy-upstream-rq-timeout-ms 和 x-envoy-max-retries。</p>
<h4 id="故障注入"><a href="#故障注入" class="headerlink" title="故障注入"></a>故障注入</h4><p>可以为符合特定条件的请求配置故障，还可以进一步限制遭受故障的请求的百分比。可以注入两种类型的故障：延迟和中断。延迟是计时故障，模拟网络延迟上升或上游服务超载的情况。中断是模拟上游服务的崩溃故障。中断通常以 HTTP 错误代码或 TCP 连接失败的形式表现。</p>
<p>对其中的 10% 注入 5 秒钟的延迟。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: VirtualService</span><br><span class="line">spec:</span><br><span class="line">  http:</span><br><span class="line">  - fault:</span><br><span class="line">      delay:</span><br><span class="line">        percent: 10</span><br><span class="line">        fixedDelay: 5s</span><br></pre></td></tr></table></figure></p>
<p>对其中的 10% 注入 HTTP 400 错误<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http:</span><br><span class="line">- fault:</span><br><span class="line">    abort:</span><br><span class="line">      percent: 10</span><br><span class="line">      httpStatus: 400</span><br></pre></td></tr></table></figure></p>
<h3 id="策略与遥测"><a href="#策略与遥测" class="headerlink" title="策略与遥测"></a>策略与遥测</h3><p>Istio 提供灵活的模型来执行授权策略，并为网格中的服务收集遥测数据。</p>
<p>基础设施后端旨在提供用于构建服务的支持功能。它们包括访问控制系统，遥测捕获系统，配额执行系统，计费系统等等。服务传统上直接与这些后端系统集成，创建硬耦合，还有沾染特定的语义和使用选项。Istio 提供统一抽象，使得 Istio 可以与一组开放式基础设施后端进行交互。</p>
<p>Mixer 是负责提供策略控制和遥测收集的 Istio 组件：</p>
<p><img src="/images/mixer.png" alt="upload successful"></p>
<p>在每次请求执行先决条件检查之前以及在每次报告遥测请求之后，Envoy sidecar 在逻辑上调用 Mixer。</p>
<p>该 sidecar 具有本地缓存，从而可以在缓存中执行相对较大比例的前提条件检查。此外，sidecar 缓冲出站遥测，使其实际上不需要经常调用 Mixer。</p>
<ul>
<li>适配器</li>
</ul>
<p>Mixer 是高度模块化和可扩展的组件。他的一个关键功能就是把不同后端的策略和遥测收集系统的细节抽象出来，使得 Istio 的其余部分对这些后端不知情。</p>
<p>Mixer 处理不同基础设施后端的灵活性是通过使用通用插件模型实现的。每个插件都被称为 Adapter，Mixer通过它们与不同的基础设施后端连接，这些后端可提供核心功能，例如日志、监控、配额、ACL 检查等。通过配置能够决定在运行时使用的确切的适配器套件，并且可以轻松扩展到新的或定制的基础设施后端。</p>
<h4 id="策略"><a href="#策略" class="headerlink" title="策略"></a>策略</h4><h5 id="速率限制（限流）"><a href="#速率限制（限流）" class="headerlink" title="速率限制（限流）"></a>速率限制（限流）</h5><p>为实现速率限制，需要配置 memquota、quota、rule、QuotaSpec 以及 QuotaSpecBinding 五个对象：</p>
<p>$ istioctl create -f samples/bookinfo/policy/mixer-rule-ratings-ratelimit.yaml</p>
<ul>
<li>memquota：速率限制</li>
<li>quota：应用范围表达式</li>
<li>rule：使用 quota 模板将 dimensions 数据映射给 memquota 进行处理</li>
<li>QuotaSpec：为创建的 quota 实例设置 charge 值</li>
<li>QuotaSpecBinding：QuotaSpec 绑定到需要应用限流的服务上</li>
</ul>
<h5 id="Denier以及黑白名单"><a href="#Denier以及黑白名单" class="headerlink" title="Denier以及黑白名单"></a>Denier以及黑白名单</h5><p>在 Istio 环境里，可以使用 Mixer 中的任何属性来对服务进行访问控制。这是一种简易的访问控制，使用 Mixer 选择器来有条件的拒绝请求。</p>
<h6 id="Denier"><a href="#Denier" class="headerlink" title="Denier"></a>Denier</h6><p>运行下列命令设置一条拒绝规则，其中包含了一个 handler 以及一个 instance。</p>
<p>$ istioctl create -f samples/bookinfo/policy/mixer-rule-deny-label.yaml</p>
<h6 id="黑白名单"><a href="#黑白名单" class="headerlink" title="黑白名单"></a>黑白名单</h6><p>配置和前面的 Denier 配置是等价的，配置元素包括：listchecker，listentry，rule</p>
<h4 id="遥测"><a href="#遥测" class="headerlink" title="遥测"></a>遥测</h4><h5 id="分布式跟踪"><a href="#分布式跟踪" class="headerlink" title="分布式跟踪"></a>分布式跟踪</h5><p>istio-demo.yaml 或者 istio-demo-auth.yaml 模板中都包含了跟踪支持，或者还可以使用 Helm chart 的方式进行部署，需要设置 –set tracing.enabled=true 选项。</p>
<p>Jaeger dashboard 的访问：</p>
<p>$ kubectl port-forward -n istio-system $(kubectl get pod -n istio-system -l app=jaeger -o jsonpath=’{.items[0].metadata.name}’) 16686:16686 &amp;</p>
<p>打开浏览器访问 <a href="http://localhost:16686" target="_blank" rel="noopener">http://localhost:16686</a> 来访问 Jaeger 的 Dashboard。</p>
<h5 id="收集指标和日志"><a href="#收集指标和日志" class="headerlink" title="收集指标和日志"></a>收集指标和日志</h5><p>Mixer 使用的是缺省配置（–configDefaultNamespace=istio-system）。如果使用的是不同的值，需要根据实际情况对文中提及的的配置和命令进行变更。</p>
<ol>
<li><p>新建一个 YAML 文件，用来配置新的指标以及数据流，Istio 将会进行自动生成和收集的工作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"># 指标 instance 的配置</span><br><span class="line">apiVersion: &quot;config.istio.io/v1alpha2&quot;</span><br><span class="line">kind: metric</span><br><span class="line">metadata:</span><br><span class="line">  name: doublerequestcount</span><br><span class="line">  namespace: istio-system</span><br><span class="line">spec:</span><br><span class="line">  value: &quot;2&quot; # 每个请求计数两次</span><br><span class="line">  dimensions:</span><br><span class="line">    source: source.service | &quot;unknown&quot;</span><br><span class="line">    destination: destination.service | &quot;unknown&quot;</span><br><span class="line">    message: &apos;&quot;twice the fun!&quot;&apos;</span><br><span class="line">  monitored_resource_type: &apos;&quot;UNSPECIFIED&quot;&apos;</span><br><span class="line">---</span><br><span class="line"># prometheus handler 的配置</span><br><span class="line">apiVersion: &quot;config.istio.io/v1alpha2&quot;</span><br><span class="line">kind: prometheus</span><br><span class="line">metadata:</span><br><span class="line">  name: doublehandler</span><br><span class="line">  namespace: istio-system</span><br><span class="line">spec:</span><br><span class="line">  metrics:</span><br><span class="line">  - name: double_request_count # Prometheus 指标名称</span><br><span class="line">    instance_name: doublerequestcount.metric.istio-system # Mixer Instance 名称（全限定名称）</span><br><span class="line">    kind: COUNTER</span><br><span class="line">    label_names:</span><br><span class="line">    - source</span><br><span class="line">    - destination</span><br><span class="line">    - message</span><br><span class="line">---</span><br><span class="line"># 将指标 Instance 发送给 prometheus handler 的 rule 对象</span><br><span class="line">apiVersion: &quot;config.istio.io/v1alpha2&quot;</span><br><span class="line">kind: rule</span><br><span class="line">metadata:</span><br><span class="line">  name: doubleprom</span><br><span class="line">  namespace: istio-system</span><br><span class="line">spec:</span><br><span class="line">  actions:</span><br><span class="line">  - handler: doublehandler.prometheus</span><br><span class="line">    instances:</span><br><span class="line">    - doublerequestcount.metric</span><br><span class="line">---</span><br><span class="line"># logentry（日志条目）的 instance 配置</span><br><span class="line">apiVersion: &quot;config.istio.io/v1alpha2&quot;</span><br><span class="line">kind: logentry</span><br><span class="line">metadata:</span><br><span class="line">  name: newlog</span><br><span class="line">  namespace: istio-system</span><br><span class="line">spec:</span><br><span class="line">  severity: &apos;&quot;warning&quot;&apos;</span><br><span class="line">  timestamp: request.time</span><br><span class="line">  variables:</span><br><span class="line">    source: source.labels[&quot;app&quot;] | source.service | &quot;unknown&quot;</span><br><span class="line">    user: source.user | &quot;unknown&quot;</span><br><span class="line">    destination: destination.labels[&quot;app&quot;] | destination.service | &quot;unknown&quot;</span><br><span class="line">    responseCode: response.code | 0</span><br><span class="line">    responseSize: response.size | 0</span><br><span class="line">    latency: response.duration | &quot;0ms&quot;</span><br><span class="line">  monitored_resource_type: &apos;&quot;UNSPECIFIED&quot;&apos;</span><br><span class="line">---</span><br><span class="line"># stdio（标准输入输出）handler 的配置</span><br><span class="line">apiVersion: &quot;config.istio.io/v1alpha2&quot;</span><br><span class="line">kind: stdio</span><br><span class="line">metadata:</span><br><span class="line">  name: newhandler</span><br><span class="line">  namespace: istio-system</span><br><span class="line">spec:</span><br><span class="line"> severity_levels:</span><br><span class="line">   warning: 1 # Params.Level.WARNING</span><br><span class="line"> outputAsJson: true</span><br><span class="line">---</span><br><span class="line"># 将 logentry instance 发送到 stdio 的 rule 对象配置</span><br><span class="line">apiVersion: &quot;config.istio.io/v1alpha2&quot;</span><br><span class="line">kind: rule</span><br><span class="line">metadata:</span><br><span class="line">  name: newlogstdio</span><br><span class="line">  namespace: istio-system</span><br><span class="line">spec:</span><br><span class="line">  match: &quot;true&quot; # 匹配所有请求</span><br><span class="line">  actions:</span><br><span class="line">   - handler: newhandler.stdio</span><br><span class="line">     instances:</span><br><span class="line">     - newlog.logentry</span><br></pre></td></tr></table></figure>
</li>
<li><p>把新配置推送给集群。<br>$ istioctl create -f new_telemetry.yaml</p>
</li>
<li><p>向示例应用发送流量。<br>在浏览器中打开 Bookinfo 应用的 product 页面：http://$GATEWAY_URL/productpage，或者使用如下的等价命令：<br>$ curl http://$GATEWAY_URL/productpage</p>
</li>
<li><p>复查新指标的生成和收集情况。<br>在 Kubernetes 环境中，使用下面的命令为 Prometheus 设置端口转发：<br>$ kubectl -n istio-system port-forward $(kubectl -n istio-system get pod -l app=prometheus -o jsonpath=’{.items[0].metadata.name}’) 9090:9090 &amp;<br>使用 Prometheus 界面查看新的指标。</p>
</li>
<li><p>检查请求过程中生成和处理的日志流。<br>在 Kubernetes 环境中，像这样在 istio-telemetry pod 中搜索日志：<br>$ kubectl -n istio-system logs $(kubectl -n istio-system get pods -l istio-mixer-type=telemetry -o jsonpath=’{.items[0].metadata.name}’) -c mixer | grep \”instance\”:\”newlog.logentry.istio-system\”</p>
</li>
</ol>
<p>更多还包括安全,性能与可伸缩性等，请参考官方文档。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>容器抽象统一了应用的分发和运行的标准；<br>kubernetes成了资源管理和应用调度编排的标准；<br>istio也在向应用/微服务通用的运行时平台前进。</p>
<p>最后，输出一个SpringBoot2程序在Istio环境下的实践Example：<br><a href="https://github.com/masenmiao/acloud-istio-example" target="_blank" rel="noopener">https://github.com/masenmiao/acloud-istio-example</a></p>
<h2 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h2><p>Istio是什么<br><a href="https://istio.io/zh/docs/concepts/what-is-istio/" target="_blank" rel="noopener">https://istio.io/zh/docs/concepts/what-is-istio/</a><br>流量管理<br><a href="https://istio.io/zh/docs/concepts/traffic-management/" target="_blank" rel="noopener">https://istio.io/zh/docs/concepts/traffic-management/</a><br>控制 Ingress 流量<br><a href="https://istio.io/zh/docs/tasks/traffic-management/ingress/" target="_blank" rel="noopener">https://istio.io/zh/docs/tasks/traffic-management/ingress/</a><br><a href="https://istio.io/zh/blog/2018/v1alpha3-routing/" target="_blank" rel="noopener">https://istio.io/zh/blog/2018/v1alpha3-routing/</a></p>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div></div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.jpg" alt="masen 微信支付"/>
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt="masen 支付宝"/>
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    masen
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://wewld.com/2018/11/08/Service-Mesh/" title="服务网格">https://wewld.com/2018/11/08/Service-Mesh/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/10/04/控平台/" rel="next" title="监控">
                <i class="fa fa-chevron-left"></i> 监控
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">masen</p>
              <p class="site-description motion-element" itemprop="description">my learning and summary</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">12</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/masenmiao" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:masen.miao@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Istio"><span class="nav-number">1.</span> <span class="nav-text">Istio</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#架构模式："><span class="nav-number">1.1.</span> <span class="nav-text">架构模式：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设计目标"><span class="nav-number">1.2.</span> <span class="nav-text">设计目标</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#流量管理"><span class="nav-number">1.3.</span> <span class="nav-text">流量管理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Pilot-和-Envoy"><span class="nav-number">1.3.1.</span> <span class="nav-text">Pilot 和 Envoy</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#流量管理的好处"><span class="nav-number">1.3.2.</span> <span class="nav-text">流量管理的好处</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#服务之间的通讯"><span class="nav-number">1.3.3.</span> <span class="nav-text">服务之间的通讯</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#网关与路由"><span class="nav-number">1.3.4.</span> <span class="nav-text">网关与路由</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#在服务之间分拆流量"><span class="nav-number">1.3.4.1.</span> <span class="nav-text">在服务之间分拆流量</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#金丝雀部署"><span class="nav-number">1.3.4.2.</span> <span class="nav-text">金丝雀部署</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#服务发现和负载均衡"><span class="nav-number">1.3.5.</span> <span class="nav-text">服务发现和负载均衡</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#目标规则-负载均衡策略"><span class="nav-number">1.3.5.1.</span> <span class="nav-text">目标规则-负载均衡策略</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#故障处理"><span class="nav-number">1.3.6.</span> <span class="nav-text">故障处理</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#请求超时"><span class="nav-number">1.3.6.1.</span> <span class="nav-text">请求超时</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#重试"><span class="nav-number">1.3.6.2.</span> <span class="nav-text">重试</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#目标规则-熔断"><span class="nav-number">1.3.6.3.</span> <span class="nav-text">目标规则-熔断</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#微调"><span class="nav-number">1.3.6.4.</span> <span class="nav-text">微调</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#故障注入"><span class="nav-number">1.3.7.</span> <span class="nav-text">故障注入</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#策略与遥测"><span class="nav-number">1.4.</span> <span class="nav-text">策略与遥测</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#策略"><span class="nav-number">1.4.1.</span> <span class="nav-text">策略</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#速率限制（限流）"><span class="nav-number">1.4.1.1.</span> <span class="nav-text">速率限制（限流）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Denier以及黑白名单"><span class="nav-number">1.4.1.2.</span> <span class="nav-text">Denier以及黑白名单</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Denier"><span class="nav-number">1.4.1.2.1.</span> <span class="nav-text">Denier</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#黑白名单"><span class="nav-number">1.4.1.2.2.</span> <span class="nav-text">黑白名单</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#遥测"><span class="nav-number">1.4.2.</span> <span class="nav-text">遥测</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#分布式跟踪"><span class="nav-number">1.4.2.1.</span> <span class="nav-text">分布式跟踪</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#收集指标和日志"><span class="nav-number">1.4.2.2.</span> <span class="nav-text">收集指标和日志</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">2.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考："><span class="nav-number">3.</span> <span class="nav-text">参考：</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">masen</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
